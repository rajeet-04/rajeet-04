name: Sync repositories to README

on:
  schedule:
    - cron: '0 * * * *' # hourly at minute 0 (every hour)
  workflow_dispatch: {}

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (manual)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # Clone authenticated so we can push later
          rm -rf repo || true
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} repo
          cd repo
          # Ensure correct branch
          git fetch --all
          if [ -n "${{ github.ref_name }}" ]; then
            git checkout "${{ github.ref_name }}" || git checkout main
          else
            git checkout main
          fi

      - name: Prepare clean working tree
        working-directory: repo
        run: |
          set -e
          # Make sure origin is up to date and we are on the correct branch
          git fetch origin --prune
          BRANCH="${GITHUB_REF_NAME:-main}"
          # Checkout branch tracking origin; create local branch if needed
          git checkout -B "$BRANCH" "origin/$BRANCH" || git checkout -B main origin/main
          # If there are any in-progress merges, abort them and reset to remote
          if [ -n "$(git ls-files -u)" ]; then
            echo "Unmerged files detected; aborting merge and resetting to origin/$BRANCH"
            git merge --abort || true
            git reset --hard "origin/$BRANCH"
          else
            # Ensure clean working tree matching origin
            git reset --hard "origin/$BRANCH"
          fi
          git clean -fdx

      - name: Install Node.js 18
        run: |
          set -e
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs

      - name: Run update scripts
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        working-directory: repo
        run: |
          node ./scripts/update_repos.js
          node ./scripts/fetch_stats.js

      - name: Commit & push changes (manual git)
        working-directory: repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git status --porcelain
          git add README.md gh_stats.svg || true
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore: sync repository table in README"
          # Push using the already-authenticated origin URL
          git push origin HEAD
